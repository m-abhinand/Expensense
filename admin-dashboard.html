<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Admin Dashboard</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <style>
        .admin-header {
            background-color: #2a2a50;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        
        .admin-header h1 {
            color: white;
            margin: 0;
        }
        
        .admin-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-btn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background-color: white;
            color: #2a2a50;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .admin-tab:hover {
            background-color: #f5f5f5;
        }
        
        .admin-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .users-table,
        .expenses-table,
        .budgets-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .users-table th,
        .users-table td,
        .expenses-table th,
        .expenses-table td,
        .budgets-table th,
        .budgets-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .users-table th,
        .expenses-table th,
        .budgets-table th {
            background-color: #f9f9f9;
            font-weight: 500;
        }
        
        .users-table tr:hover,
        .expenses-table tr:hover,
        .budgets-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .user-details {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .user-details h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
            background-color: #777;
        }
        
        .category-food { background-color: #4CAF50; }
        .category-transportation { background-color: #2196F3; }
        .category-housing { background-color: #9C27B0; }
        .category-utilities { background-color: #FF9800; }
        .category-entertainment { background-color: #E91E63; }
        .category-shopping { background-color: #00BCD4; }
        .category-health { background-color: #F44336; }
        .category-travel { background-color: #795548; }
        .category-education { background-color: #607D8B; }
        .category-other { background-color: #9E9E9E; }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-title {
            font-size: 14px;
            color: #777;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* Database View Styles */
        .db-table-selector {
            margin-bottom: 20px;
        }
        
        .db-selector {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }
        
        .db-table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        
        .db-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .db-table th {
            position: sticky;
            top: 0;
            background-color: #f5f5f5;
            z-index: 10;
        }
        
        .db-table th, .db-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }
        
        .db-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .db-table-info {
            margin-bottom: 10px;
            font-size: 14px;
            color: #777;
        }
        
        .db-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .db-empty {
            padding: 30px;
            text-align: center;
            color: #777;
            font-style: italic;
        }
        
        /* User Action Styles */
        .action-btn {
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 5px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        
        .reset-btn {
            background-color: #2196F3;
            color: white;
        }
        
        .reset-btn:hover {
            background-color: #0b7dda;
        }
        
        /* Delete confirmation modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .modal-backdrop.active {
            display: block;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #4f46e5;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid #ddd;
        }
        
        .btn-outline:hover {
            background-color: #f5f5f5;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .warning-icon {
            font-size: 24px;
            color: #f44336;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .warning-text {
            color: #f44336;
            font-weight: 500;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <h1>Admin Dashboard</h1>
            <button id="admin-logout" class="logout-btn">Logout</button>
        </div>
    </header>
    
    <main class="container">
        <div class="admin-stats" id="admin-stats">
            <!-- Will be populated dynamically -->
        </div>
        
        <div class="admin-tabs">
            <div class="admin-tab active" data-tab="users">Users</div>
            <div class="admin-tab" data-tab="expenses">Expenses</div>
            <div class="admin-tab" data-tab="budgets">Budgets</div>
            <div class="admin-tab" data-tab="database">Database</div>
        </div>
        
        <div class="tab-content active" id="users-tab">
            <div class="search-box">
                <input type="text" id="search-users" placeholder="Search users by name or email...">
            </div>
            <table class="users-table" id="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Joined</th>
                        <th>Expenses</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Will be populated dynamically -->
                </tbody>
            </table>
        </div>
        
        <div class="tab-content" id="expenses-tab">
            <div class="search-box">
                <input type="text" id="search-expenses" placeholder="Search expenses by user, category or amount...">
            </div>
            <div id="expenses-container">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        
        <div class="tab-content" id="budgets-tab">
            <div class="search-box">
                <input type="text" id="search-budgets" placeholder="Search budgets by user...">
            </div>
            <div id="budgets-container">
                <!-- Will be populated dynamically -->
            </div>
        </div>
        
        <div class="tab-content" id="database-tab">
            <div class="db-actions">
                <div class="db-table-selector">
                    <select id="db-table-select" class="db-selector">
                        <option value="" disabled selected>Select a table to view</option>
                        <option value="users">Users</option>
                        <option value="expenses">Expenses</option>
                        <option value="budgets">Budgets</option>
                        <option value="bills">Bills</option>
                    </select>
                </div>
                <div class="search-box" style="margin-bottom: 0; flex: 1; margin-left: 15px;">
                    <input type="text" id="search-db" placeholder="Search in table...">
                </div>
            </div>
            <div class="db-table-info" id="db-table-info"></div>
            <div class="db-table-wrapper">
                <table class="db-table" id="db-table">
                    <thead>
                        <tr id="db-table-header">
                            <!-- Will be populated dynamically -->
                        </tr>
                    </thead>
                    <tbody id="db-table-body">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <!-- Reset Password Modal -->
    <div class="modal" id="reset-password-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reset User Password</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Set a new password for <strong id="reset-user-name"></strong></p>
                <form id="reset-password-form">
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" name="new-password" required minlength="6">
                        <span class="error-message" id="new-password-error"></span>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirm Password</label>
                        <input type="password" id="confirm-password" name="confirm-password" required minlength="6">
                        <span class="error-message" id="confirm-password-error"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="confirm-reset-password" class="btn btn-primary" data-user-id="" data-user-email="">Reset Password</button>
                <button class="btn btn-outline cancel-reset-password">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Delete User Confirmation Modal -->
    <div class="modal" id="delete-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete User</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-icon">⚠️</div>
                <p>Are you sure you want to delete user <strong id="delete-user-name"></strong>?</p>
                <p>This will permanently remove the user account and all associated data including:</p>
                <ul>
                    <li>All expense records</li>
                    <li>Budget settings</li>
                    <li>Bills and recurring payments</li>
                    <li>User preferences</li>
                </ul>
                <p class="warning-text">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button id="confirm-delete-user" class="btn btn-danger" data-user-id="" data-user-email="">Delete User</button>
                <button class="btn btn-outline cancel-delete-user">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Backdrop for modals -->
    <div class="modal-backdrop" id="modal-backdrop"></div>
    
    <script src="./js/utils.js"></script>
    <script src="./js/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin authentication
            requireAdminAuth();
            
            // Handle logout
            document.getElementById('admin-logout').addEventListener('click', function() {
                sessionStorage.removeItem('adminAuthenticated');
                window.location.href = 'index.html';
            });
            
            // Tab navigation
            const tabs = document.querySelectorAll('.admin-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Hide all tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show corresponding tab content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Load and display data
            loadAdminDashboard();
            
            // Search functionality
            document.getElementById('search-users').addEventListener('input', function() {
                filterUsers(this.value.toLowerCase());
            });
            
            document.getElementById('search-expenses').addEventListener('input', function() {
                filterExpenses(this.value.toLowerCase());
            });
            
            document.getElementById('search-budgets').addEventListener('input', function() {
                filterBudgets(this.value.toLowerCase());
            });
            
            // Database view functionality
            const dbTableSelect = document.getElementById('db-table-select');
            dbTableSelect.addEventListener('change', function() {
                const selectedTable = this.value;
                if (selectedTable) {
                    loadDatabaseTable(selectedTable);
                }
            });
            
            document.getElementById('search-db').addEventListener('input', function() {
                filterDatabaseTable(this.value.toLowerCase());
            });
            
            // Handle modal close buttons
            const closeModalButtons = document.querySelectorAll('.close-modal, .cancel-delete-user, .cancel-reset-password');
            closeModalButtons.forEach(button => {
                button.addEventListener('click', function() {
                    closeAllModals();
                });
            });
            
            // User deletion confirmation
            const confirmDeleteUserBtn = document.getElementById('confirm-delete-user');
            confirmDeleteUserBtn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userEmail = this.getAttribute('data-user-email');
                
                if (userId && userEmail) {
                    deleteUser(userId, userEmail);
                    closeAllModals();
                }
            });
            
            // Password reset confirmation
            const confirmResetPasswordBtn = document.getElementById('confirm-reset-password');
            confirmResetPasswordBtn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const userEmail = this.getAttribute('data-user-email');
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (validateResetPassword(newPassword, confirmPassword)) {
                    resetUserPassword(userId, userEmail, newPassword);
                    closeAllModals();
                }
            });
        });
        
        // Load dashboard data
        function loadAdminDashboard() {
            const users = getAllUsersData();
            const expenses = getAllExpensesData();
            const budgets = getAllBudgetsData();
            
            // Load statistics
            loadStatistics(users, expenses, budgets);
            
            // Load users table
            loadUsersTable(users, expenses);
            
            // Load expenses data
            loadExpensesData(expenses);
            
            // Load budgets data
            loadBudgetsData(budgets);
        }
        
        // Load statistics
        function loadStatistics(users, expenses, budgets) {
            const statsContainer = document.getElementById('admin-stats');
            
            // Calculate total users
            const totalUsers = users.length;
            
            // Calculate total expenses
            let totalExpensesAmount = 0;
            let totalExpensesCount = 0;
            Object.values(expenses).forEach(userExpenses => {
                totalExpensesCount += userExpenses.length;
                userExpenses.forEach(expense => {
                    totalExpensesAmount += parseFloat(expense.amount);
                });
            });
            
            // Calculate total budgets
            let totalBudgetsAmount = 0;
            let budgetsCount = 0;
            Object.values(budgets).forEach(userBudgets => {
                if (userBudgets.monthly && userBudgets.monthly.amount) {
                    totalBudgetsAmount += parseFloat(userBudgets.monthly.amount);
                    budgetsCount++;
                }
                if (userBudgets.weekly && userBudgets.weekly.amount) {
                    totalBudgetsAmount += parseFloat(userBudgets.weekly.amount);
                    budgetsCount++;
                }
            });
            
            // Calculate average expense amount
            const averageExpense = totalExpensesCount > 0 ? 
                (totalExpensesAmount / totalExpensesCount).toFixed(2) : 0;
            
            // Render stats
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">Total Users</div>
                    <div class="stat-value">${totalUsers}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Expenses</div>
                    <div class="stat-value">${totalExpensesCount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Expense Amount</div>
                    <div class="stat-value">${formatCurrency(totalExpensesAmount)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Average Expense</div>
                    <div class="stat-value">${formatCurrency(averageExpense)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Budgets</div>
                    <div class="stat-value">${budgetsCount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Budget Amount</div>
                    <div class="stat-value">${formatCurrency(totalBudgetsAmount)}</div>
                </div>
            `;
        }
        
        // Load users table
        function loadUsersTable(users, expenses) {
            const tableBody = document.querySelector('#users-table tbody');
            
            if (users.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No users found</td></tr>`;
                return;
            }
            
            let html = '';
            users.forEach(user => {
                const userExpenses = expenses[user.email] || [];
                const totalExpenses = userExpenses.length;
                
                html += `
                    <tr data-user-id="${user.id}" class="user-row">
                        <td>${user.id.substring(0, 8)}...</td>
                        <td>${user.name || user.fullname || 'N/A'}</td>
                        <td>${user.email}</td>
                        <td>${user.joined ? formatDate(user.joined) : 'N/A'}</td>
                        <td>${totalExpenses}</td>
                        <td>
                            <button class="action-btn reset-btn" 
                                data-user-id="${user.id}" 
                                data-user-email="${user.email}"
                                data-user-name="${user.name || user.fullname || user.email}">
                                Reset Password
                            </button>
                            <button class="action-btn delete-btn" 
                                data-user-id="${user.id}" 
                                data-user-email="${user.email}"
                                data-user-name="${user.name || user.fullname || user.email}">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const userEmail = this.getAttribute('data-user-email');
                    const userName = this.getAttribute('data-user-name');
                    
                    openDeleteUserModal(userId, userEmail, userName);
                });
            });
            
            // Add event listeners to reset password buttons
            document.querySelectorAll('.reset-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const userEmail = this.getAttribute('data-user-email');
                    const userName = this.getAttribute('data-user-name');
                    
                    openResetPasswordModal(userId, userEmail, userName);
                });
            });
        }
        
        // Load expenses data
        function loadExpensesData(expenses) {
            const container = document.getElementById('expenses-container');
            
            if (Object.keys(expenses).length === 0) {
                container.innerHTML = `<p class="text-center">No expenses found</p>`;
                return;
            }
            
            let html = '';
            
            // For each user
            Object.entries(expenses).forEach(([userEmail, userExpenses]) => {
                if (userExpenses.length === 0) return;
                
                // Calculate total for this user
                let userTotal = 0;
                userExpenses.forEach(expense => {
                    userTotal += parseFloat(expense.amount);
                });
                
                html += `
                    <div class="user-details expense-user-details" data-user-email="${userEmail}">
                        <h3>${userEmail} <span style="float: right; font-weight: normal;">Total: ${formatCurrency(userTotal)}</span></h3>
                        <table class="expenses-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Category</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Sort expenses by date (newest first)
                userExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Add each expense
                userExpenses.forEach(expense => {
                    html += `
                        <tr class="expense-row" data-expense-id="${expense.id}">
                            <td>${formatDate(expense.date)}</td>
                            <td>${formatCurrency(expense.amount)}</td>
                            <td><span class="category-badge category-${expense.category}">${getCategoryName(expense.category)}</span></td>
                            <td>${expense.notes || 'N/A'}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Load budgets data
        function loadBudgetsData(budgets) {
            const container = document.getElementById('budgets-container');
            
            if (Object.keys(budgets).length === 0) {
                container.innerHTML = `<p class="text-center">No budgets found</p>`;
                return;
            }
            
            let html = '';
            
            // For each user
            Object.entries(budgets).forEach(([userEmail, userBudgets]) => {
                if (Object.keys(userBudgets).length === 0) return;
                
                html += `
                    <div class="user-details budget-user-details" data-user-email="${userEmail}">
                        <h3>${userEmail}</h3>
                        <table class="budgets-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Date Set</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Add monthly budget if exists
                if (userBudgets.monthly && userBudgets.monthly.amount) {
                    html += `
                        <tr>
                            <td>Monthly</td>
                            <td>${formatCurrency(userBudgets.monthly.amount)}</td>
                            <td>${userBudgets.monthly.date ? formatDate(userBudgets.monthly.date) : 'N/A'}</td>
                        </tr>
                    `;
                }
                
                // Add weekly budget if exists
                if (userBudgets.weekly && userBudgets.weekly.amount) {
                    html += `
                        <tr>
                            <td>Weekly</td>
                            <td>${formatCurrency(userBudgets.weekly.amount)}</td>
                            <td>${userBudgets.weekly.date ? formatDate(userBudgets.weekly.date) : 'N/A'}</td>
                        </tr>
                    `;
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Filter users
        function filterUsers(query) {
            const rows = document.querySelectorAll('#users-table .user-row');
            
            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const email = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (name.includes(query) || email.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Filter expenses
        function filterExpenses(query) {
            const userSections = document.querySelectorAll('.expense-user-details');
            
            userSections.forEach(section => {
                const userEmail = section.getAttribute('data-user-email').toLowerCase();
                const expenseRows = section.querySelectorAll('.expense-row');
                let hasVisibleRows = false;
                
                // First check if the user email matches
                const userMatch = userEmail.includes(query);
                
                // Then check individual expenses
                expenseRows.forEach(row => {
                    const category = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    const amount = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    const notes = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    
                    if (userMatch || category.includes(query) || amount.includes(query) || notes.includes(query)) {
                        row.style.display = '';
                        hasVisibleRows = true;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Show/hide the entire user section
                section.style.display = hasVisibleRows ? '' : 'none';
            });
        }
        
        // Filter budgets
        function filterBudgets(query) {
            const userSections = document.querySelectorAll('.budget-user-details');
            
            userSections.forEach(section => {
                const userEmail = section.getAttribute('data-user-email').toLowerCase();
                
                if (userEmail.includes(query)) {
                    section.style.display = '';
                } else {
                    section.style.display = 'none';
                }
            });
        }
        
        // ======= Database View Functions =======
        
        // Load a database table
        function loadDatabaseTable(tableName) {
            const tableHeader = document.getElementById('db-table-header');
            const tableBody = document.getElementById('db-table-body');
            const tableInfo = document.getElementById('db-table-info');
            
            // Clear previous content
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            let data = [];
            let columns = [];
            
            // Get data based on table name
            switch(tableName) {
                case 'users':
                    data = getAllUsersData();
                    if (data.length > 0) {
                        columns = Object.keys(data[0]);
                    }
                    break;
                    
                case 'expenses':
                    const allExpenses = getAllExpensesData();
                    // Flatten the expenses data structure
                    Object.entries(allExpenses).forEach(([email, expenses]) => {
                        expenses.forEach(expense => {
                            data.push({
                                user_email: email,
                                ...expense
                            });
                        });
                    });
                    if (data.length > 0) {
                        columns = Object.keys(data[0]);
                    }
                    break;
                    
                case 'budgets':
                    const allBudgets = getAllBudgetsData();
                    // Flatten the budget data structure
                    Object.entries(allBudgets).forEach(([email, budgets]) => {
                        if (budgets.monthly && budgets.monthly.amount) {
                            data.push({
                                user_email: email,
                                type: 'monthly',
                                amount: budgets.monthly.amount,
                                date: budgets.monthly.date || 'N/A'
                            });
                        }
                        if (budgets.weekly && budgets.weekly.amount) {
                            data.push({
                                user_email: email,
                                type: 'weekly',
                                amount: budgets.weekly.amount,
                                date: budgets.weekly.date || 'N/A'
                            });
                        }
                    });
                    if (data.length > 0) {
                        columns = Object.keys(data[0]);
                    }
                    break;
                    
                case 'bills':
                    // Get bills data from localStorage if it exists
                    const billsData = localStorage.getItem('bills');
                    if (billsData) {
                        const parsedBills = JSON.parse(billsData);
                        Object.entries(parsedBills).forEach(([email, bills]) => {
                            bills.forEach(bill => {
                                data.push({
                                    user_email: email,
                                    ...bill
                                });
                            });
                        });
                    }
                    if (data.length > 0) {
                        columns = Object.keys(data[0]);
                    }
                    break;
            }
            
            // Display table info
            tableInfo.textContent = `Showing ${data.length} records from '${tableName}' table`;
            
            // If no data
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="100%" class="db-empty">No data found in ${tableName} table</td></tr>`;
                return;
            }
            
            // Create table header
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                tableHeader.appendChild(th);
            });
            
            // Create table rows
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'db-row';
                
                columns.forEach(column => {
                    const td = document.createElement('td');
                    let cellValue = item[column];
                    
                    // Format specific values
                    if (column === 'date' || column === 'dueDate') {
                        cellValue = cellValue ? formatDate(cellValue) : 'N/A';
                    } else if (column === 'amount') {
                        cellValue = formatCurrency(cellValue);
                    } else if (typeof cellValue === 'object') {
                        cellValue = JSON.stringify(cellValue);
                    } else if (cellValue === undefined || cellValue === null) {
                        cellValue = 'N/A';
                    }
                    
                    td.textContent = cellValue;
                    row.appendChild(td);
                });
                
                tableBody.appendChild(row);
            });
            
            // Store the raw data for filtering
            tableBody.dataset.table = tableName;
        }
        
        // Filter the database table based on search query
        function filterDatabaseTable(query) {
            const tableBody = document.getElementById('db-table-body');
            const rows = tableBody.querySelectorAll('.db-row');
            
            let visibleCount = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let found = false;
                
                cells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(query)) {
                        found = true;
                    }
                });
                
                if (found) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update table info with filter results
            const tableInfo = document.getElementById('db-table-info');
            const tableName = tableBody.dataset.table || '';
            
            if (query) {
                tableInfo.textContent = `Showing ${visibleCount} of ${rows.length} records from '${tableName}' table (filtered)`;
            } else {
                tableInfo.textContent = `Showing ${rows.length} records from '${tableName}' table`;
            }
        }
        
        // Open delete user confirmation modal
        function openDeleteUserModal(userId, userEmail, userName) {
            const modal = document.getElementById('delete-user-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const confirmBtn = document.getElementById('confirm-delete-user');
            const userNameSpan = document.getElementById('delete-user-name');
            
            // Set the user details in the modal
            userNameSpan.textContent = userName;
            confirmBtn.setAttribute('data-user-id', userId);
            confirmBtn.setAttribute('data-user-email', userEmail);
            
            // Show the modal
            modal.classList.add('active');
            backdrop.classList.add('active');
        }
        
        // Open reset password modal
        function openResetPasswordModal(userId, userEmail, userName) {
            const modal = document.getElementById('reset-password-modal');
            const backdrop = document.getElementById('modal-backdrop');
            const confirmBtn = document.getElementById('confirm-reset-password');
            const userNameSpan = document.getElementById('reset-user-name');
            
            // Reset form and clear errors
            document.getElementById('reset-password-form').reset();
            document.getElementById('new-password-error').textContent = '';
            document.getElementById('confirm-password-error').textContent = '';
            
            // Set the user details in the modal
            userNameSpan.textContent = userName;
            confirmBtn.setAttribute('data-user-id', userId);
            confirmBtn.setAttribute('data-user-email', userEmail);
            
            // Show the modal
            modal.classList.add('active');
            backdrop.classList.add('active');
        }
        
        // Close all modals
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            const backdrop = document.getElementById('modal-backdrop');
            
            modals.forEach(modal => {
                modal.classList.remove('active');
            });
            
            backdrop.classList.remove('active');
        }
        
        // Validate reset password form
        function validateResetPassword(newPassword, confirmPassword) {
            let isValid = true;
            
            // Clear previous errors
            document.getElementById('new-password-error').textContent = '';
            document.getElementById('confirm-password-error').textContent = '';
            
            // Validate new password
            if (!newPassword || newPassword.length < 6) {
                document.getElementById('new-password-error').textContent = 'Password must be at least 6 characters';
                isValid = false;
            }
            
            // Validate confirm password
            if (newPassword !== confirmPassword) {
                document.getElementById('confirm-password-error').textContent = 'Passwords do not match';
                isValid = false;
            }
            
            return isValid;
        }
        
        // Reset a user's password
        function resetUserPassword(userId, userEmail, newPassword) {
            // 1. Get all users
            let users = getAllUsersData();
            
            // 2. Find the user by ID
            const userIndex = users.findIndex(user => user.id === userId);
            
            if (userIndex !== -1) {
                // 3. Update the password
                users[userIndex].password = newPassword;
                
                // 4. Save back to localStorage
                localStorage.setItem('users', JSON.stringify(users));
                
                // 5. Show success message
                showMessage(`Password reset for ${userEmail} successfully`, 'success');
            } else {
                showMessage(`User not found`, 'error');
            }
        }
        
        // Delete a user and their data
        function deleteUser(userId, userEmail) {
            // 1. Delete user from users array
            let users = getAllUsersData();
            users = users.filter(user => user.id !== userId);
            localStorage.setItem('users', JSON.stringify(users));
            
            // 2. Delete user's expenses
            const allExpenses = JSON.parse(localStorage.getItem('expenses') || '{}');
            if (allExpenses[userEmail]) {
                delete allExpenses[userEmail];
                localStorage.setItem('expenses', JSON.stringify(allExpenses));
            }
            
            // 3. Delete user's budgets
            const allBudgets = JSON.parse(localStorage.getItem('budgets') || '{}');
            if (allBudgets[userEmail]) {
                delete allBudgets[userEmail];
                localStorage.setItem('budgets', JSON.stringify(allBudgets));
            }
            
            // 4. Delete user's bills if they exist
            const allBills = JSON.parse(localStorage.getItem('bills') || '{}');
            if (allBills[userEmail]) {
                delete allBills[userEmail];
                localStorage.setItem('bills', JSON.stringify(allBills));
            }
            
            // 5. Reload the admin dashboard data
            loadAdminDashboard();
            
            // 6. Show success message
            showMessage(`User ${userEmail} has been deleted successfully`, 'success');
        }
        
        // Show a message to the user
        function showMessage(message, type = 'info') {
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `message message-${type}`;
            messageElement.innerHTML = `
                <div class="message-content">
                    ${message}
                    <button class="close-message">×</button>
                </div>
            `;
            
            // Add styles
            const styles = `
                .message {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 1100;
                    max-width: 350px;
                    transform: translateX(400px);
                    transition: transform 0.3s ease;
                }
                .message-show {
                    transform: translateX(0);
                }
                .message-content {
                    padding: 15px 20px;
                    background-color: white;
                    border-radius: 5px;
                    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .message-success { border-left: 5px solid #4CAF50; }
                .message-info { border-left: 5px solid #2196F3; }
                .message-warning { border-left: 5px solid #FFC107; }
                .message-error { border-left: 5px solid #F44336; }
                .close-message {
                    background: none;
                    border: none;
                    font-size: 18px;
                    cursor: pointer;
                    margin-left: 10px;
                }
            `;
            
            // Add styles to head if they don't exist
            if (!document.getElementById('message-styles')) {
                const styleElem = document.createElement('style');
                styleElem.id = 'message-styles';
                styleElem.textContent = styles;
                document.head.appendChild(styleElem);
            }
            
            // Add to document
            document.body.appendChild(messageElement);
            
            // Add animation
            setTimeout(() => {
                messageElement.classList.add('message-show');
            }, 10);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                messageElement.classList.remove('message-show');
                messageElement.addEventListener('transitionend', () => {
                    if (messageElement.parentNode) {
                        messageElement.parentNode.removeChild(messageElement);
                    }
                });
            }, 4000);
            
            // Close button
            const closeBtn = messageElement.querySelector('.close-message');
            closeBtn.addEventListener('click', () => {
                messageElement.classList.remove('message-show');
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.parentNode.removeChild(messageElement);
                    }
                }, 300);
            });
        }
    </script>
</body>
</html>
